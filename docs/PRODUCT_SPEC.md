# Продуктовая спецификация: AI ROI Calculator

## 1. Обзор продукта

**AI ROI Calculator** — веб-сервис, позволяющий оценить экономическую эффективность внедрения ИИ-решения в бизнес-процесс. Пользователь описывает текущий процесс (AS-IS) и целевой (TO-BE), ошибки, затраты на внедрение — и получает расчёт ROI с графиками динамики окупаемости.

### Ключевые ценности
- **Структурированный подход** — пошаговое описание процесса с конкретными метриками
- **Наглядность** — графики окупаемости, точка безубыточности, динамика экономии
- **ИИ-ассистент** — генерация этапов, ошибок и затрат по текстовому описанию с верификацией
- **Готовые шаблоны** — библиотека предзаполненных расчётов для типовых процессов
- **Без регистрации** — мгновенный доступ к расчёту

---

## 2. Роли пользователей

### 2.1 Анонимный пользователь
- Создаёт новый расчёт с нуля
- Загружает расчёт из библиотеки шаблонов
- Заполняет/редактирует все блоки расчёта
- Использует ИИ-ассистент для автоматической генерации этапов, ошибок и затрат
- Просматривает результаты и графики
- Может вернуться к ранее проделанному расчёту (по уникальной ссылке, ID хранится в localStorage)

### 2.2 Зарегистрированный пользователь
- Все возможности анонимного пользователя
- Регистрация/вход по email + пароль
- Расчёты привязаны к аккаунту: доступны с любого устройства
- История расчётов хранится на сервере (не зависит от браузера/устройства)

### 2.3 Администратор
- Все возможности зарегистрированного пользователя
- Роль `ADMIN` назначается автоматически при регистрации, если email входит в `ADMIN_EMAILS` (env-переменная)
- В открытом расчёте видит кнопку **«Сохранить как шаблон»**
- Создаёт шаблоны из реальных расчётов (все данные включая стоимости переносятся в шаблон)
- Управляет шаблонами на странице `/templates/manage`: публикует, снимает с публикации, удаляет

---

## 3. Пользовательский flow

```
Главная страница
├── [Новый расчёт] → Переход к пустому калькулятору
├── [Загрузить из библиотеки] → Список шаблонов → Выбор → Калькулятор с предзаполненными данными
└── [Мои расчёты] → Список ранее сохранённых → Выбор → Калькулятор с данными

Калькулятор (основной экран):
├── Шаг 1: Описание процесса AS-IS (таблица этапов)
├── Шаг 2: Описание процесса TO-BE (таблица этапов)
├── Шаг 3: Ошибки AS-IS (таблица ошибок)
├── Шаг 4: Ошибки TO-BE (таблица ошибок)
├── Шаг 5: Динамика раскатки (выбор модели + параметры)
├── Шаг 6: CAPEX (таблица единовременных затрат)
├── Шаг 7: OPEX (таблица ежемесячных затрат)
└── Шаг 8: Результаты — ROI, графики, ключевые метрики
```

---

## 4. Блоки расчёта

### 4.1 Процесс AS-IS (текущее состояние)

Таблица с динамическим добавлением строк и перетаскиванием для изменения порядка:

| Поле | Тип | Описание |
|------|-----|----------|
| Этап | string | Название шага процесса |
| Сотрудник | string | Роль/должность исполнителя |
| Цена часа | number (₽) | Стоимость часа работы сотрудника |
| Время в часах | number | Трудозатраты на этап |
| Календарный срок в днях | number | Длительность этапа в календарных днях |
| Доп. затраты | number (₽) | Прямые затраты на этап (подрядчик, внешний сервис и т.п.) |
| Стоимость этапа | computed (₽) | = Цена часа × Время в часах + Доп. затраты |
| Доля в выполнении | number (0-1) | Какая доля случаев проходит через этот этап |
| Удельное время | computed | = Время в часах × Доля в выполнении |
| Удельная стоимость | computed (₽) | = Стоимость этапа × Доля в выполнении |

**Итого по процессу:**
- Суммарное удельное время
- Суммарная удельная стоимость
- Суммарный календарный срок

### 4.2 Процесс TO-BE (целевое состояние с ИИ)

Структура полностью аналогична AS-IS (включая перетаскивание строк). Кнопка «Скопировать из AS-IS» копирует все строки AS-IS в TO-BE одним кликом. Кнопка «Заполнить с ИИ» позволяет описать изменения текстом — ИИ сам создаст TO-BE на основе AS-IS, либо предложит автоматизацию по запросу «предположи сам».

### 4.3 Ошибки AS-IS

Таблица ошибок текущего процесса с перетаскиванием для изменения порядка:

| Поле | Тип | Описание |
|------|-----|----------|
| Тип ошибки | string | Описание ошибки |
| Этап процесса | string | На каком этапе возникает |
| Частота (доля случаев) | number (0-1) | Как часто возникает ошибка |
| Стоимость исправления | number (₽) | Сколько стоит исправить одну ошибку |
| Время на исправление (ч) | number | Время на исправление одной ошибки |
| Удельная стоимость ошибки | computed (₽) | = Частота × Стоимость исправления |
| Удельное время ошибки | computed | = Частота × Время на исправление |

### 4.4 Ошибки TO-BE

Аналогично ошибкам AS-IS (включая перетаскивание строк). Кнопка «Скопировать из AS-IS» копирует все строки AS-IS в TO-BE одним кликом — с учётом того, что ИИ снижает частоту и/или стоимость ошибок. Кнопка «Заполнить с ИИ» автоматически формирует реалистичную картину остаточных ошибок TO-BE на основе AS-IS ошибок и целевого процесса.

### 4.5 Динамика раскатки

Определяет, как быстро ИИ-решение внедряется в операции.

| Поле | Тип | Описание |
|------|-----|----------|
| Модель раскатки | enum | `linear` / `s_curve` / `instant` |
| Срок полной раскатки (мес.) | number | За сколько месяцев достигается 100% (не для instant) |
| Целевая доля операций | number (0-1) | Максимальная доля операций с ИИ (может быть < 100%) |
| Объём операций в месяц | number | Базовый объём выполнений процесса в месяц |
| Рост объёма операций | boolean | Опциональная динамика роста количества операций |
| Тип роста | enum | `COMPOUND` (% в месяц) / `LINEAR_ABS` (фикс. прирост) |
| Ставка роста | number | Для COMPOUND — % в месяц; для LINEAR_ABS — операций/мес. |
| Потолок операций | number? | Максимальный объём операций (null = без ограничений) |

**Модели раскатки:**
- **Моментальная (instant):** 100% целевой доли с первого месяца
- **Линейная (linear):** равномерный рост от 0% до целевой доли за указанный срок
- **S-кривая (s_curve):** медленный старт → быстрый рост → замедление при приближении к целевой доле

**Динамика роста объёма операций (опционально):**
- **Процентный рост (COMPOUND):** каждый месяц объём умножается на `(1 + rate)` — соответствует органическому росту бизнеса
- **Линейный прирост (LINEAR_ABS):** каждый месяц к базовому объёму добавляется фиксированное число операций
- Потолок ограничивает максимальный объём (например, ограничения производственных мощностей)
- Формула: `Операций(месяц t) = min(base × (1+rate)^(t-1), ceiling)` для COMPOUND или `min(base + rate×(t-1), ceiling)` для LINEAR_ABS

### 4.6 CAPEX (единовременные затраты)

Таблица с динамическим добавлением строк:

| Поле | Тип | Описание |
|------|-----|----------|
| Статья затрат | string | Описание (разработка, лицензия, оборудование...) |
| Стоимость | number (₽) | Сумма |
| Комментарий | string | Пояснение (опционально) |

### 4.7 OPEX (ежемесячные затраты)

| Поле | Тип | Описание |
|------|-----|----------|
| Статья затрат | string | Описание (подписка API, поддержка, инфраструктура...) |
| Стоимость в месяц | number (₽) | Сумма в месяц |
| Комментарий | string | Пояснение (опционально) |

---

## 5. Расчёт ROI

### 5.1 Базовые метрики

```
Экономия на процессе (за 1 операцию) =
  Удельная стоимость AS-IS − Удельная стоимость TO-BE

Экономия на ошибках (за 1 операцию) =
  Σ Удельная стоимость ошибок AS-IS − Σ Удельная стоимость ошибок TO-BE

Общая экономия за 1 операцию =
  Экономия на процессе + Экономия на ошибках

Экономия времени за 1 операцию =
  (Удельное время AS-IS + Удельное время ошибок AS-IS)
  − (Удельное время TO-BE + Удельное время ошибок TO-BE)
```

### 5.2 Помесячный расчёт

```
Для каждого месяца t:

  Доля_раскатки(t) = f(модель_раскатки, t)
  Операций_с_ИИ(t) = Объём_операций × Доля_раскатки(t)

  Выгода(t) = Операций_с_ИИ(t) × Общая_экономия_за_операцию
  Затраты_OPEX(t) = Σ OPEX_статей

  Чистая_выгода(t) = Выгода(t) − Затраты_OPEX(t)

Накопленная_выгода(T) = Σ Чистая_выгода(t) для t от 1 до T
Накопленные_затраты(T) = CAPEX + Σ Затраты_OPEX(t) для t от 1 до T

ROI(T) = (Накопленная_выгода(T) − CAPEX) / (CAPEX + Накопленные_OPEX(T)) × 100%
```

### 5.3 Точка окупаемости

Месяц `T`, в котором `Накопленная_чистая_выгода(T) ≥ CAPEX`

### 5.4 Мультипликаторы производительности

Показывают, во сколько раз улучшился процесс после внедрения ИИ. Вычисляются на основе данных шагов AS-IS и TO-BE:

```
Рост производительности (человеко-часы) =
  Удельное время AS-IS / Удельное время TO-BE

Снижение стоимости =
  Удельная стоимость AS-IS / Удельная стоимость TO-BE

Ускорение процесса (календарные дни) =
  Суммарный срок AS-IS / Суммарный срок TO-BE
  (показывается только если в обеих версиях заполнено поле «Дни»)
```

Отображаются на экране результатов в блоке «Эффект автоматизации» с указанием значений AS-IS и TO-BE.

---

## 6. Графики

### 6.1 Динамика окупаемости (главный график)
- **Тип:** Area chart
- **Ось X:** Месяцы (1..24 или настраиваемый горизонт)
- **Линия 1:** Накопленная выгода (зелёная область)
- **Линия 2:** Накопленные затраты (красная область)
- **Маркер:** Точка окупаемости (вертикальная линия + подпись)
- **Tooltip:** Детали при наведении на месяц

### 6.2 Помесячная экономия
- **Тип:** Stacked bar chart
- **Ось X:** Месяцы
- **Столбец 1:** Экономия на процессе (синий)
- **Столбец 2:** Экономия на ошибках (зелёный)
- **Столбец 3:** OPEX затраты (красный, отрицательный)
- **Линия:** Чистая выгода за месяц

### 6.3 Кривая раскатки
- **Тип:** Line chart
- **Ось X:** Месяцы
- **Ось Y:** % операций с ИИ
- **Показывает:** Выбранную модель раскатки (linear / s-curve / instant)

### 6.4 Сравнение AS-IS vs TO-BE
- **Тип:** Horizontal bar chart
- **Сравнение:** Стоимость и время на операцию — до и после
- **Включает:** Стоимость процесса + стоимость ошибок

---

## 7. Библиотека шаблонов

### Структура шаблона
Шаблон — это полноценный расчёт (`Calculation` с `isTemplate = true`), содержащий все данные:
- Название, описание, отрасль/категория
- Этапы процесса AS-IS и TO-BE (со всеми полями включая стоимости и ставки)
- Ошибки AS-IS и TO-BE (со всеми полями)
- Статьи CAPEX и OPEX (с суммами)
- Конфигурация раскатки

### Создание шаблона (только администратор)
1. Администратор заполняет расчёт как обычно
2. Нажимает кнопку **«Сохранить как шаблон»** (видна только пользователям с ролью `ADMIN`)
3. В диалоге указывает название, описание, отрасль; выбирает «Создать новый» или «Заменить существующий»
4. Шаблон создаётся как полная копия расчёта и сразу публикуется

### При загрузке шаблона
Пользователь получает полноценный предзаполненный расчёт со всеми данными из шаблона — готов к немедленному просмотру результатов или редактированию под свои нужды.

---

## 8. Сохранение и доступ к расчётам

### Автосохранение
- Расчёт автоматически сохраняется при каждом изменении
- Каждый расчёт получает уникальный ID (UUID)
- URL формат: `/{calculation_id}`

### История расчётов

**Авторизованный пользователь:**
- Расчёты привязаны к аккаунту (поле `userId`)
- «Мои расчёты» загружаются с сервера — доступны с любого устройства
- ID в localStorage не сохраняются

**Анонимный пользователь:**
- Список ID расчётов хранится в localStorage браузера
- На странице «Мои расчёты» показаны только расчёты с текущего устройства

### Шаринг
- Любой расчёт доступен по прямой ссылке (по ID) без авторизации
- Ссылку можно скопировать и отправить коллеге

---

## 9. Экраны приложения

### 9.1 Главная страница
- Заголовок и краткое описание сервиса
- Три CTA-кнопки: «Новый расчёт», «Из библиотеки», «Мои расчёты»
- Краткое описание что делает сервис

### 9.2 Калькулятор
- Навигация по шагам (stepper/tabs сверху)
- Активный шаг отображает соответствующую таблицу или форму
- Кнопки «Назад» / «Далее» между шагами
- На шагах ввода (Процесс AS-IS, TO-BE, Ошибки AS-IS, TO-BE, CAPEX, OPEX):
  - Кнопка **«Заполнить с ИИ»** (иконка ✦) — открывает диалог ИИ-генерации
  - Диалог: ввод описания → индикатор прогресса → превью результата → кнопки «Применить» / «Перегенерировать» / «Отмена»
- На шаге «Результаты» — ключевые цифры + графики:
  - KPI-карточки: ROI, точка окупаемости, экономия за год, экономия за операцию
  - Блок «Эффект автоматизации»: во сколько раз выросла производительность, снизилась стоимость и ускорился процесс (см. п. 5.4)
  - Детализация экономии по категориям (процесс / ошибки)
  - Четыре графика: динамика окупаемости, помесячная экономия, кривая раскатки, сравнение AS-IS vs TO-BE
  - Кнопка **«Скачать PDF»** — генерирует профессиональный PDF-отчёт с колонтитулами AIM (см. п. 12)
- Кнопка «Скопировать ссылку» для шаринга расчёта
- Название расчёта (редактируемое)
- Перетаскивание строк (drag & drop) для изменения порядка этапов и ошибок
- Кнопка «Скопировать из AS-IS» на шагах TO-BE (процесс и ошибки)

### 9.3 Библиотека шаблонов
- Карточки шаблонов с названием, описанием, отраслью
- Фильтр по отрасли/категории
- При клике — предпросмотр шаблона и кнопка «Использовать»

### 9.4 Мои расчёты
- Для авторизованных: список расчётов из БД, доступен с любого устройства
- Для анонимных: список из localStorage текущего устройства
- Сортировка по дате изменения
- Удаление из списка

### 9.5 Страница авторизации (`/login`)
- Форма входа (email + пароль) и регистрации (два таба)
- После успешного входа/регистрации — редирект на «Мои расчёты»
- Заголовок: кнопка «Войти» для анонимных; email + меню выхода для авторизованных

### 9.6 Управление шаблонами (`/templates/manage`, только ADMIN)
- Список всех шаблонов (опубликованных и черновиков)
- Публикация / снятие с публикации
- Удаление с подтверждением
- Переход к шаблону (открывается как обычный расчёт)
- Ссылка на управление видна в выпадающем меню пользователя в заголовке

---

## 10. Нефункциональные требования

- **Производительность:** расчёты выполняются на клиенте (мгновенно)
- **Адаптивность:** корректно работает на десктопе и планшете (мобайл — low priority)
- **Доступность:** базовая — контрастность, фокус на элементах, семантика
- **Безопасность:** админ-токен хранится в env-переменной, не хардкодится; ключ OpenRouter передаётся только через серверный API-роут — клиент его не видит

---

## 11. ИИ-ассистент генерации данных

### 11.1 Концепция

На каждой из 6 вкладок ввода калькулятора (Процесс AS-IS, TO-BE, Ошибки AS-IS, TO-BE, CAPEX, OPEX) доступна кнопка **«Заполнить с ИИ»**. Пользователь описывает процесс свободным текстом — ИИ генерирует структурированные данные и предлагает их для подтверждения.

### 11.2 Пользовательский сценарий

1. Пользователь нажимает «Заполнить с ИИ» на нужной вкладке
2. Открывается диалог с контекстной подсказкой (что уже заполнено, что будет учтено)
3. В диалоге отображаются модели, которые будут использованы для генерации (из `/api/ai/active-models`)
4. Пользователь описывает процесс в текстовом поле (Ctrl/Cmd+Enter — быстрый запуск)
5. Запускается двухшаговая цепочка: генерация → верификация (прогресс и цепочка моделей отображаются)
6. Отображается превью результата: читаемая таблица + пояснение ИИ
7. Пользователь нажимает «Применить» (заменяет данные) или «Перегенерировать»

### 11.3 Двухшаговая цепочка промптов

| Шаг | Модель (по умолчанию) | Роль |
|-----|------------------------|------|
| 1. Генерация | `google/gemini-2.5-flash` | Формирует список этапов/ошибок/затрат по описанию |
| 2. Верификация | `google/gemini-2.0-flash-001` | Проверяет реалистичность, логику, полноту; исправляет |

Модели настраиваются через БД (AiConfig) или env-переменные. Пользователь видит актуальные модели в диалоге перед генерацией. Оба запроса выполняются на сервере через API-роут `/api/ai/generate` — ключ OpenRouter никогда не покидает серверную сторону.

### 11.4 Контекст, учитываемый при генерации

Каждая вкладка получает релевантный контекст из уже заполненных данных:

| Вкладка | Учитываемый контекст |
|---------|----------------------|
| Процесс AS-IS | Название расчёта, существующие шаги AS-IS |
| Процесс TO-BE | Шаги AS-IS, существующие шаги TO-BE |
| Ошибки AS-IS | Шаги AS-IS, существующие ошибки AS-IS |
| Ошибки TO-BE | Ошибки AS-IS, шаги TO-BE, существующие ошибки TO-BE |
| CAPEX | Шаги AS-IS и TO-BE, существующие CAPEX-статьи |
| OPEX | Шаги TO-BE, CAPEX-статьи, существующие OPEX-статьи |

### 11.5 Формат ответа

ИИ всегда возвращает JSON, соответствующий типам данных калькулятора. Поле `reasoning` содержит краткое пояснение принятых решений — отображается пользователю в блоке превью.

### 11.6 Конфигурация

Модели задаются через переменные окружения (можно менять без пересборки):

```env
OPENROUTER_API_KEY="sk-or-v1-..."
AI_GENERATION_MODEL="google/gemini-2.5-flash"
AI_VERIFICATION_MODEL="google/gemini-2.0-flash-001"
```

Если `OPENROUTER_API_KEY` не задан, кнопка «Заполнить с ИИ» присутствует в интерфейсе, но при нажатии API-роут вернёт ошибку `503 — AI generation is not configured`.

---

## 12. Экспорт результатов в PDF

### 12.1 Концепция

На вкладке «Результаты» доступна кнопка **«Скачать PDF»** рядом с селектором горизонта расчёта. Генерируется профессиональный PDF-отчёт с брендингом AIM, пригодный для отправки заказчику.

### 12.2 Содержимое PDF

1. Заголовок — название расчёта и дата
2. Исходные данные расчёта — объём операций, модель раскатки, CAPEX, OPEX
3. KPI-карточки — экономия на операцию, операций с ИИ в масштабе, ROI за 12 мес., точка окупаемости
4. Мультипликаторы эффекта — рост производительности, снижение стоимости, ускорение процесса (если данные заполнены)
5. Четыре графика — динамика окупаемости, помесячная экономия, кривая раскатки, сравнение AS-IS vs TO-BE

### 12.3 Колонтитулы (по образцу корпоративного стиля AIM)

Верхний колонтитул на каждой странице:
- Левая часть: «**AIM**integrations | AIMmethod» (брендинг компании)
- Правая часть: «Расчёт ROI · Анализ экономического эффекта от внедрения ИИ»
- Тонкая серая линия-разделитель снизу

Нижний колонтитул на каждой странице (двухстрочный):
- Первая строка, левая часть: «Искусственный интеллект. / Настоящие результаты.» (курсив)
- Первая строка, правая часть: «AIMintegrations.ru | AIMmethod.ru / boost@aimintegrations.ru»
- Вторая строка, по центру: «-- N of M --» (номер и общее число страниц)
- Тонкая серая линия-разделитель сверху

### 12.4 Техническая реализация

- Кнопка отправляет запрос `GET /api/export/pdf/{id}?horizon=12|24|36`
- Серверный роут запускает Puppeteer (headless Chromium), навигирует на внутреннюю страницу `/{id}/report`
- Ждёт готовности Recharts-графиков (атрибут `data-pdf-ready`), затем генерирует PDF через `page.pdf()`
- Браузер предлагает скачать файл с именем `ROI_{название}_{горизонт}m.pdf`
- Время генерации: ~5–10 секунд (кнопка переходит в состояние загрузки)
