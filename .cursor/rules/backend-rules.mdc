---
description: Правила для работы с API и серверной логикой
globs: src/app/api/**/*.ts, src/lib/**/*.ts, prisma/**/*
---

# Правила для бэкенд-разработки

## API Routes (Next.js App Router)

- Файл: `src/app/api/{resource}/route.ts`
- Для параметризованных: `src/app/api/{resource}/[id]/route.ts`
- Каждый роут экспортирует именованные функции: GET, POST, PUT, DELETE
- Валидировать входящие данные
- Возвращать корректные HTTP-статусы (200, 201, 400, 404, 500)
- JSON-ответы с единообразной структурой: `{ data: ... }` или `{ error: "..." }`

## Prisma

- Client singleton в `src/lib/db.ts`
- Использовать транзакции при создании расчёта из шаблона (много связанных записей)
- `onDelete: Cascade` для всех дочерних сущностей
- Не хранить вычисляемые поля — они считаются на клиенте

## Модуль расчётов (`src/lib/calculations/`)

- Чистые функции, без побочных эффектов
- Входные данные — типизированные объекты
- Каждая функция в отдельном файле:
  - `process-savings.ts` — экономия на процессе
  - `error-savings.ts` — экономия на ошибках
  - `rollout.ts` — кривые раскатки
  - `roi.ts` — итоговый расчёт ROI
- Формулы задокументированы в JSDoc

## Админ-API

- Все админские роуты проверяют заголовок или параметр с токеном
- Токен сверяется с `process.env.ADMIN_SECRET_TOKEN`
- При несовпадении — 403 Forbidden
